!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self)["v-track"]=t()}(this,function(){"use strict";function V(e){return(V="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function t(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}function D(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=[],r=!0,i=!1,o=void 0;try{for(var a,c=e[Symbol.iterator]();!(r=(a=c.next()).done)&&(n.push(a.value),!t||n.length!==t);r=!0);}catch(e){i=!0,o=e}finally{try{r||null==c.return||c.return()}finally{if(i)throw o}}return n}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function I(e){return function(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}var R=function(e){return"function"==typeof e||!1},a=function(e){return null==e},c=function(e){return null!=e},_="production"===process.env.NODE_ENV;function F(e){return[Object.values(e),Object.keys(e)]}function u(e,t){if(!function(e,t){return e.key===t.key&&e.tag===t.tag&&e.isComment===t.isComment&&c(e.data)===c(t.data)}(e,t))return!1;var n=t.children,r=e.children;if(a(e.text)&&c(n)&&c(r)){if(n.length!==r.length)return!1;for(var i=0;i<r.length;i++){var o=r[i];if(c(o)&&c(n[i]))return u(o,n[i])}}else if(e.text!==t.text)return!1;return!0}function o(e,t){return window.getComputedStyle(e).getPropertyValue(t)}function U(e){if(e===window.document)return!0;if(!e||!e.parentNode)return!1;var t=e.parentNode,n=o(e,"visibility"),r=o(e,"display");return"hidden"!==n&&"none"!==r&&(!t||U(t))}var B=function(){function n(e,t){if(r(this,n),!function(e){return e&&1===e.nodeType}(e))throw new Error("not an element node");this.ele=e,this.ref=t,this.started=!1,this.listeners={},this.removeScrollLisener=null,this.init()}return t(n,[{key:"init",value:function(){var e,t=this;this.started||(this.removeScrollLisener=(e=function(i){var o,a=1<arguments.length&&void 0!==arguments[1]?arguments[1]:200;return function(){for(var e=this,t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];clearTimeout(o),o=setTimeout(function(){return i.apply(e,n)},a)}}(this.visibilitychange.bind(this)),t.ref?t.ref.$on("scroll",e):(window.addEventListener("scroll",e,!1),function(){return window.removeEventListener("scroll",e,!1)})),this.started=!0)}},{key:"$on",value:function(e,t){return(this.listeners[e]||(this.listeners[e]=[])).push(t),this}},{key:"$off",value:function(e,t){if(t){for(var n,r=this.listeners[e],i=r.length;i--;)if((n=r[i])===t||n.cbk===t){r.splice(i,1);break}return this}}},{key:"$once",value:function(i,o){var a=this,e=function e(){a.$off(i,e);for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];o.apply(a,n)};return e.cbk=o,this.$on(i,e),this}},{key:"$emit",value:function(e){for(var t=this,n=arguments.length,r=new Array(1<n?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];return(this.listeners[e]||[]).forEach(function(e){return e.apply(t,r)}),this}},{key:"visibilitychange",value:function(){var e=this.ele.getBoundingClientRect(),t={height:window.innerHeight,width:window.innerWidth};if(!function(e,t){return!(!e||e.width<=0||e.height<=0)&&0<e.bottom&&0<e.right&&e.top<t.height&&e.left<t.width}(e,t)||!U(this.ele))return 0;var n=0,r=0;0<=e.top?n=Math.min(e.height,t.height-e.top):0<e.bottom&&(n=Math.min(t.height,e.bottom)),0<=e.left?r=Math.min(e.width,t.width-e.left):0<e.right&&(r=Math.min(t.width,e.right)),1==n*r/(e.height*e.width)&&this.$emit("fullyvisible")}},{key:"destroy",value:function(){R(this.removeScrollLisener)&&this.removeScrollLisener()}}]),n}(),H=["async","delay","watch","show","once","custom"];function l(r,e,t,n,i,o){var a=this,c=e.value,u=e.arg,l=e.modifiers,f=e.rawName,s=t.context,h=t.componentInstance;if(!o[u])throw new Error("埋点参数不存在哇");var y=[],d=o[u].bind(null,s),v=function(e,t,n){return function(r,e,i,o,a){var c=this,u=5<arguments.length&&void 0!==arguments[5]?arguments[5]:{};r.$unwatch=o.$watch(function(){return o[e]},function(e,t){var n=o.$route;if(!_&&u.immediate&&!n&&!n.name&&a.watch)throw new Error("$route 不存在");e!==t&&(u.immediate&&u.name===n.name||r.contains(c.target))&&i(),c.target=null})}.call(a,r,e,t,s,l,n)},m=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return function(e,t){var n=Object.keys(e);return n.length===t.length&&t.every(function(e){return n.includes(e)})}.call(null,l,t)},p=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return function(e,t){var n=Object.keys(e);return t.some(function(e){return n.includes(e)})}.call(null,l,t)};if(Object.keys(l).length){if(m("watch")){var w=Object.keys(c).shift();v(w,d,{name:s.$route.name,immediate:!0})}else if(m("delay"))r.$timer&&clearTimeout(r.$timer),r.$timer=setTimeout(function(){o[u](s)},c);else if(m("watch","delay")){var b=I(Object.keys(c)).pop();v(b,d=function(){r.$timer&&clearTimeout(r.$timer),r.$timer=setTimeout(function(){U(s.$el)&&o[u](s)},c.delay)},{name:s.$route.name,immediate:!0})}else if(p("show")){var g=p("once"),$=p("custom");if(!r.$visMonitor){var k=new B(r,$&&s.$refs[c.ref]);(g?k.$once:k.$on).call(k,"fullyvisible",function(){return o[u](s)}),r.$visMonitor=k}}else if(!h&&l.click){switch(V(c)){case"object":var E=D(F(c),2),j=E[0],A=E[1],O=j.shift(),T=I(A).pop(),S=A.slice(1).reduce(function(e,t){return e[t]=c[t],e},{});if(!_&&!R(O))throw new Error("第一个参数应该为 Function~");d=o[u].bind(null,s,S),y=[d,O.bind.apply(O,[null].concat(I(j)))],l.delay&&y.reverse(),l.async&&v(T,y.shift());break;case"function":y=[d,c],l.delay&&y.reverse()}r.$listener=function(t){a.target=t.target,y.forEach(function(e){return e(t)})},r.addEventListener("click",r.$listener)}else if(h&&h.$el===r){var L=Object.keys(l).filter(function(e){return!H.includes(e)}).pop();switch(V(c)){case"object":var P=D(F(c),2),x=P[0],M=P[1],N=x.shift(),C=I(M).pop();if(!_&&!R(N))throw new Error("第一个参数应该为 Function~");if(r["$on_".concat(L)])break;h.$on(L,function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];a.target=(t[0].e||t[0].event).target,d=o[u].bind(null,s,t[0]),y=[d,N.bind.apply(N,[null].concat(t))],l.delay&&y.reverse(),l.async&&v(C,y.shift()),y.forEach(function(e){return e()}),r["$on_".concat(L)]=!0});break;case"function":h.$on(L,function(e){var t=Object.values(e);d=o[u].bind(null,s,e),y=[d,c.bind.apply(c,[null].concat(I(t)))],l.delay&&y.reverse(),y.forEach(function(e){return e()})})}}else if(!_)throw new Error("".concat(f,"指令暂不支持"))}else o[u](s,c)}function f(e){if(e.$listener){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];u(n[1],n[2])||(s.call(this,e),l.call.apply(l,[this,e].concat(n)))}}function s(e){e.$listener&&e.removeEventListener("click",e.$listener),e.$timer&&clearTimeout(e.$timer),e.$unwatch&&e.$unwatch(),e.$visMonitor&&e.$visMonitor.destroy()}var e,n,h,y=function(){function e(){r(this,e),this.installed=!1,this.curPage=null}return t(e,null,[{key:"install",value:function(e,t){var i=this,o=t.trackEvents,n=t.trackAction,r=this;this.installed||(this.installed=!0,e.directive("track",{bind:function(){for(var e,t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];return(e=l).call.apply(e,[i].concat(n,[o]))},componentUpdated:function(){for(var e,t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];return(e=f).call.apply(e,[i].concat(n,[o]))},unbind:function(){for(var e,t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];return(e=s).call.apply(e,[i].concat(n))}}),e.component("TrackView",{render:function(e){return e("span",{style:"display: none"})}}),e.mixin({data:function(){return{enterTime:Date.now()}},beforeRouteEnter:function(e,t,n){t.matched.length&&e.name!==r.curPage&&(r.curPage=e.name,o.UVPV()),n()},beforeRouteLeave:function(e,t,n){var r="".concat((Date.now()-this.enterTime)/1e3,"s");o.TONP({stt:r}),n()}}),Object.defineProperty(e.prototype,"$track",{get:function(){return n}}))}}]),e}();return h=null,(n="target")in(e=y)?Object.defineProperty(e,n,{value:h,enumerable:!0,configurable:!0,writable:!0}):e[n]=h,y});
